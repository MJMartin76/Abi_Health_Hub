<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Journal - Abigail's Health Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>ğŸŒ¿ Abigail's Health Hub</h1>
        <p>Your Daily Guide to Feeling Better</p>
    </header>

    <div class="container">
        <nav>
            <a href="index.html">
                <span class="icon">ğŸ </span>
                <span>Home</span>
            </a>
            <a href="schedule.html">
                <span class="icon">ğŸ“…</span>
                <span>My Schedule</span>
            </a>
            <a href="personalcare.html">
                <span class="icon">ğŸ’š</span>
                <span>Personal Care</span>
            </a>
            <a href="meals.html">
                <span class="icon">ğŸ½ï¸</span>
                <span>Meal Plans</span>
            </a>
            <a href="healthinfo.html">
                <span class="icon">ğŸ“š</span>
                <span>My Health Info</span>
            </a>
            <a href="tracker.html">
                <span class="icon">âœ…</span>
                <span>Daily Tracker</span>
            </a>
            <a href="journal.html" class="active">
                <span class="icon">ğŸ“–</span>
                <span>My Journal</span>
            </a>
            <a href="progress.html">
                <span class="icon">ğŸ“Š</span>
                <span>Progress History</span>
            </a>
            <a href="notes.html">
                <span class="icon">ğŸ“</span>
                <span>Weekly Notes</span>
            </a>
            <a href="tips.html">
                <span class="icon">ğŸ’¡</span>
                <span>Tips & Reminders</span>
            </a>
            <a href="emergency.html">
                <span class="icon">ğŸš¨</span>
                <span>When to Tell Mindy</span>
            </a>
        </nav>

        <main>
            <h2>ğŸ“– My Daily Journal</h2>

            <div class="alert-box">
                <p>Write about your day - how you're feeling, wins, challenges, or anything on your mind. Your entries are saved automatically!</p>
            </div>

            <div class="card card-border-blue">
                <h3>ğŸ“… Select Date</h3>
                <div class="date-picker">
                    <input type="date" id="journal-date" />
                    <button onclick="loadJournalDataForDate()">Load This Date</button>
                    <button onclick="loadTodayJournal()">Today</button>
                </div>
            </div>

            <div class="journal-entry">
                <h4>Journal Entry for <span id="journal-entry-date"></span></h4>
                <textarea id="journal-text" placeholder="Write your thoughts here..."></textarea>
                <button onclick="saveJournal()">ğŸ’¾ Save Entry</button>
            </div>

            <div class="card card-border-green">
                <h3>ğŸ“š Recent Entries</h3>
                <div style="margin-bottom: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="show-weekly-notes" checked style="width: 20px; height: 20px; cursor: pointer; accent-color: #4caf50;">
                        <span style="font-size: 1.1rem;">Show weekly notes in journal</span>
                    </label>
                </div>
                <div id="recent-journals"></div>
            </div>
        </main>
    </div>

    <script src="AirtableService.js"></script>
    <script src="app.js"></script>
    <script>
        // Initialize journal
		let currentJournalDate = getTodayString();

		async function initializeJournals() {
			await loadJournalData();
			await loadNotesData();
			loadTodayJournal();
			renderRecentJournals();
		}

		initializeJournals().catch(console.error);

		function loadTodayJournal() {
			currentJournalDate = getTodayString();
			const dateInput = document.getElementById('journal-date');
			if (dateInput) {
				dateInput.value = currentJournalDate;
			}
			loadJournalDataForDate();
		}

		async function loadJournalDataForDate() {
			const dateInput = document.getElementById('journal-date');
			if (dateInput && dateInput.value) {
				currentJournalDate = dateInput.value;
			}

			const displayDate = document.getElementById('journal-entry-date');
			if (displayDate) {
				displayDate.textContent = new Date(currentJournalDate + 'T12:00:00').toLocaleDateString('en-US', { 
					weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
				});
			}

			const savedJournal = JOURNAL_DATA[currentJournalDate];

			const textArea = document.getElementById('journal-text');
			if (textArea) {
				textArea.value = savedJournal?.text || '';
			}
		}

        // Add event listener for checkbox
        document.getElementById('show-weekly-notes').addEventListener('change', renderRecentJournals);

        async function renderRecentJournals() {
            const showWeeklyNotes = document.getElementById('show-weekly-notes').checked;
            const journals = [];

			const dates = Object.keys(JOURNAL_DATA);
			const recentDates = dates.sort().reverse().slice(0, 14);

            for (const day of recentDates) {
				const record = JOURNAL_DATA[day];
                if (record && record.text) {
                    journals.push({ ...record, type: 'journal' });
                }
            }

            // Also load weekly notes if checkbox is checked
            if (showWeeklyNotes) {
				const noteKeys = Object.keys(NOTES_DATA);
				for (const key of noteKeys) {
					const record = NOTES_DATA[key];
					if (record) {
                        journals.push({ ...record, type: 'weekly', date: record.weekStart_sunday });
					}
				}
            }

            journals.sort((a, b) => new Date(b.date) - new Date(a.date));
            const recent = journals.slice(0, 20);

            const container = document.getElementById('recent-journals');
            if (!container) return;

            if (recent.length === 0) {
                container.innerHTML = '<p style="color: #666;">No entries yet. Start writing!</p>';
                return;
            }

            container.innerHTML = recent.map(entry => {
                if (entry.type === 'journal') {
                    return `
                        <div class="saved-journal">
                            <h4>
                                ğŸ“– ${new Date(entry.date + 'T12:00:00').toLocaleDateString('en-US', { 
                                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                                })}
                                <button class="delete-btn" onclick="deleteJournal('${entry.date}')">Delete</button>
                            </h4>
                            <p>${entry.text}</p>
                        </div>
                    `;
                } else {
                    // Weekly notes entry
                    const weekDate = new Date(entry.date + 'T12:00:00').toLocaleDateString('en-US', { 
                        month: 'long', day: 'numeric', year: 'numeric' 
                    });
                    return `
                        <div class="saved-journal" style="background: linear-gradient(135deg, #fff9e6, #fff3e0); border-color: #ffa726;">
                            <h4 style="color: #f57c00;">
                                ğŸ“ Weekly Notes - Week of ${weekDate}
                            </h4>
                            ${entry.energyBest ? `<p><strong>Best energy time:</strong> ${entry.energyBest}</p>` : ''}
                            ${entry.energyWorst ? `<p><strong>Worst energy time:</strong> ${entry.energyWorst}</p>` : ''}
                            ${entry.energyHelp ? `<p><strong>Activities that help:</strong> ${entry.energyHelp}</p>` : ''}
                            ${entry.energyDrain ? `<p><strong>Activities that drain:</strong> ${entry.energyDrain}</p>` : ''}
                            ${entry.painLevel ? `<p><strong>Joint pain level:</strong> ${entry.painLevel}/10</p>` : ''}
                            ${entry.tremorLevel ? `<p><strong>Tremor severity:</strong> ${entry.tremorLevel}/10</p>` : ''}
                            ${entry.tremorTrigger ? `<p><strong>Tremor triggers:</strong> ${entry.tremorTrigger}</p>` : ''}
                            ${entry.tremorCalm ? `<p><strong>What helped tremors:</strong> ${entry.tremorCalm}</p>` : ''}
                            ${entry.waterIntake ? `<p><strong>Average water intake:</strong> ${entry.waterIntake} oz/day</p>` : ''}
                            ${entry.speechWins ? `<p><strong>Speech therapy wins:</strong> ${entry.speechWins}</p>` : ''}
                            ${entry.otCompleted ? `<p><strong>OT exercises:</strong> ${entry.otCompleted}</p>` : ''}
                            ${entry.ptImprovements ? `<p><strong>PT improvements:</strong> ${entry.ptImprovements}</p>` : ''}
                            ${entry.skillsMastering ? `<p><strong>Skills mastering:</strong> ${entry.skillsMastering}</p>` : ''}
                            ${entry.goal1 || entry.goal2 || entry.goal3 ? `<p><strong>Goals for next week:</strong><br>` +
                                (entry.goal1 ? `1. ${entry.goal1}<br>` : '') +
                                (entry.goal2 ? `2. ${entry.goal2}<br>` : '') +
                                (entry.goal3 ? `3. ${entry.goal3}` : '') + `</p>` : ''}
                        </div>
                    `;
                }
            }).join('');
        }

		async function saveJournal() {
			const textArea = document.getElementById('journal-text');
			if (!textArea) return;
			const text = textArea.value;
			await updateJournal(currentJournalDate, text);
			alert('âœ… Journal entry saved!');
		}		

		async function deleteJournal(date) {
			if (confirm('Are you sure you want to delete this journal entry?')) {
				await updateJournal(date, ''); // just empty the text
				loadRecentJournals();
			}
		}
		
		async function updateJournal(date, text) {
			const savedRecord = JOURNAL_DATA[date];
			const newRecord = {
				recordId: savedRecord?.recordId,
				text,
				date,
			}
			const [updatedRecord] = await AirtableService.upsertRecords(TABLES.JOURNAL, [newRecord]);
			if (updatedRecord) {
				JOURNAL_DATA[updatedRecord.date] = updatedRecord;
			}

			renderRecentJournals();
		}
    </script>
</body>
</html>